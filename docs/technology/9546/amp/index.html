<!doctype html>
<html amp lang="zh-TW">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
	<script type='application/ld+json' class='yoast-schema-graph yoast-schema-graph--main'>{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://daynews.cc/#website","url":"https://daynews.cc/","name":"\u5929\u5929\u8981\u805e","description":"\u4e00\u7db2\u6253\u76e1\u5168\u7db2\u6700\u65b0\u8cc7\u8a0a\u6700\u71b1\u982d\u689d\u65b0","potentialAction":{"@type":"SearchAction","target":"https://daynews.cc/?s={search_term_string}","query-input":"required name=search_term_string"}},{"@type":"ImageObject","@id":"https://daynews.cc/technology/9546/#primaryimage","url":"http://p1.pstatp.com/large/pgc-image/RkHewbSAUXXdXM"},{"@type":"WebPage","@id":"https://daynews.cc/technology/9546/#webpage","url":"https://daynews.cc/technology/9546/","inLanguage":"zh-TW","name":"\u9060\u8d85\u96d911\uff01eBay\u767e\u842cTPS\u652f\u4ed8\u8cec\u52d9\u7cfb\u7d71\u7684\u8a2d\u8a08\u8207\u5be6\u73fe - \u5929\u5929\u8981\u805e","isPartOf":{"@id":"https://daynews.cc/#website"},"primaryImageOfPage":{"@id":"https://daynews.cc/technology/9546/#primaryimage"},"datePublished":"2019-12-10T20:45:15+00:00","dateModified":"2019-12-10T20:45:15+00:00","author":{"@id":"https://daynews.cc/#/schema/person/038ceb5ed68cf11f9ec94ba43c7ff55d"}},{"@type":["Person"],"@id":"https://daynews.cc/#/schema/person/038ceb5ed68cf11f9ec94ba43c7ff55d","name":"\u5929\u5929\u8981\u805e","image":{"@type":"ImageObject","@id":"https://daynews.cc/#authorlogo","url":"https://secure.gravatar.com/avatar/e786821a74ef0467825a7d60183307bc?s=96&d=mm&r=g","caption":"\u5929\u5929\u8981\u805e"},"sameAs":[]}]}</script>
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="一、序 ebay於2018年全面展開了下一代支付系統的設計和實現。支付寶的雙十一和微信財付通的春節紅包已經向世界展示了支付行業當前的工程成果。那麼作為下一代支付系統，如何才能做得更好？支付寶的支付系統能支撐雙十一期間高達幾十萬的並發量，我們的支付系統有沒有可能支持得更高、更穩定？ 俗話說擒賊先擒王，支付系統最重要的組件之一是賬務系統，有著……" />
<meta name="twitter:title" content="遠超雙11！eBay百萬TPS支付賬務系統的設計與實現 - 天天要聞" />
<meta name="twitter:image" content="http://p1.pstatp.com/large/pgc-image/RkHewbSAUXXdXM" />
<meta property="og:locale" content="zh_TW" />
<meta property="og:type" content="article" />
<meta property="og:title" content="遠超雙11！eBay百萬TPS支付賬務系統的設計與實現 - 天天要聞" />
<meta property="og:description" content="一、序 ebay於2018年全面展開了下一代支付系統的設計和實現。支付寶的雙十一和微信財付通的春節紅包已經向世界展示了支付行業當前的工程成果。那麼作為下一代支付系統，如何才能做得更好？支付寶的支付系統能支撐雙十一期間高達幾十萬的並發量，我們的支付系統有沒有可能支持得更高、更穩定？ 俗話說擒賊先擒王，支付系統最重要的組件之一是賬務系統，有著……" />
<meta property="og:url" content="https://daynews.cc/technology/9546/" />
<meta property="og:site_name" content="天天要聞" />
<meta property="article:section" content="科技" />
<meta property="article:published_time" content="2019-12-10T20:45:15+00:00" />
	<title>遠超雙11！eBay百萬TPS支付賬務系統的設計與實現 - 天天要聞</title>
		<link rel="canonical" href="https://daynews.cc/technology/9546/" />
	<script type='text/javascript' src='https://cdn.ampproject.org/v0.js' async></script>
<script type='text/javascript' src='https://cdn.ampproject.org/v0/amp-analytics-0.1.js' async custom-element="amp-analytics"></script>
<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><meta name="generator" content="AMP Plugin v1.4.1; mode=reader; experiences=website"><meta name="generator" content="WordPress 5.2.4" />
	<style amp-custom>
		/* Generic WP styling */

.alignright {
	float: right;
}

.alignleft {
	float: left;
}

.aligncenter {
	display: block;
	text-align: center;
	margin-left: auto;
	margin-right: auto;
}

.amp-wp-enforced-sizes {
	/** Our sizes fallback is 100vw, and we have a padding on the container; the max-width here prevents the element from overflowing. **/
	max-width: 100%;
	margin: 0 auto;
}


/*
 * Prevent cases of amp-img converted from img to appear with stretching by using object-fit to scale.
 * See <https://github.com/ampproject/amphtml/issues/21371#issuecomment-475443219>.
 * Also use object-fit:contain in worst case scenario when we can't figure out dimensions for an image.
 * Additionally, in side of \AMP_Img_Sanitizer::determine_dimensions() it could $amp_img->setAttribute( 'object-fit', 'contain' )
 * so that the following rules wouldn't be needed.
 */
amp-img.amp-wp-enforced-sizes[layout="intrinsic"] > img,
amp-anim.amp-wp-enforced-sizes[layout="intrinsic"] > img {
	object-fit: contain;
}

amp-fit-text blockquote,
amp-fit-text h1,
amp-fit-text h2,
amp-fit-text h3,
amp-fit-text h4,
amp-fit-text h5,
amp-fit-text h6 {
	font-size: inherit;
}

/**
 * Override a style rule in Twenty Sixteen and Twenty Seventeen.
 * It set display:none for audio elements.
 * This selector is the same, though it adds body and uses amp-audio instead of audio.
 */
body amp-audio:not([controls]) {
	display: inline-block;
	height: auto;
}

/*
 * Style the default template messages for submit-success, submit-error, and submitting. These elements are inserted
 * by the form sanitizer when a POST form lacks the action-xhr attribute.
 */
.amp-wp-default-form-message > p {
	margin: 1em 0;
	padding: 0.5em;
}

.amp-wp-default-form-message[submitting] > p,
.amp-wp-default-form-message[submit-success] > p.amp-wp-form-redirecting {
	font-style: italic;
}

.amp-wp-default-form-message[submit-success] > p:not(.amp-wp-form-redirecting) {
	border: solid 1px #008000;
	background-color: #90ee90;
	color: #000;
}

.amp-wp-default-form-message[submit-error] > p {
	border: solid 1px #f00;
	background-color: #ffb6c1;
	color: #000;
}

/* Prevent showing empty success message in the case of an AMP-Redirect-To response header. */
.amp-wp-default-form-message[submit-success] > p:empty {
	display: none;
}

amp-carousel .amp-wp-gallery-caption {
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
	text-align: center;
	background-color: rgba(0, 0, 0, 0.5);
	color: #fff;
	padding: 1rem;
}

.wp-block-gallery[data-amp-carousel="true"] {
	display: block;
	flex-wrap: unset;
}

/* Template Styles */

.amp-wp-content,
.amp-wp-title-bar div {
		margin: 0 auto;
	max-width: 600px;
	}

html {
	background: #0a89c0;
}

body {
	background: #fff;
	color: #353535;
	font-family: Georgia, 'Times New Roman', Times, Serif;
	font-weight: 300;
	line-height: 1.75em;
}

p,
ol,
ul,
figure {
	margin: 0 0 1em;
	padding: 0;
}

a,
a:visited {
	color: #0a89c0;
}

a:hover,
a:active,
a:focus {
	color: #353535;
}

/* Quotes */

blockquote {
	color: #353535;
	background: rgba(127,127,127,.125);
	border-left: 2px solid #0a89c0;
	margin: 8px 0 24px 0;
	padding: 16px;
}

blockquote p:last-child {
	margin-bottom: 0;
}

/* UI Fonts */

.amp-wp-meta,
.amp-wp-header div,
.amp-wp-title,
.wp-caption-text,
.amp-wp-tax-category,
.amp-wp-tax-tag,
.amp-wp-comments-link,
.amp-wp-footer p,
.back-to-top {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

/* Header */

.amp-wp-header {
	background-color: #0a89c0;
}

.amp-wp-header div {
	color: #fff;
	font-size: 1em;
	font-weight: 400;
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: .875em 16px;
	position: relative;
}

.amp-wp-header a {
	color: #fff;
	text-decoration: none;
}

	.amp-wp-header .amp-wp-canonical-link {
		font-size: 0.8em;
		text-decoration: underline;
		position: absolute;
		right: 18px;	}

.amp-wp-header .amp-wp-site-icon {
	/** site icon is 32px **/
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 50%;
	position: absolute;
	right: 18px;
	top: 10px;
}

/* Article */

.amp-wp-article {
	color: #353535;
	font-weight: 400;
	margin: 1.5em auto;
	max-width: 840px;
	overflow-wrap: break-word;
	word-wrap: break-word;
}

/* Article Header */

.amp-wp-article-header {
	align-items: center;
	align-content: stretch;
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	margin: 1.5em 16px 0;
}

.amp-wp-title {
	color: #353535;
	display: block;
	flex: 1 0 100%;
	font-weight: 900;
	margin: 0 0 .625em;
	width: 100%;
}

/* Article Meta */

.amp-wp-meta {
	color: #696969;
	display: inline-block;
	flex: 2 1 50%;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0 0 1.5em;
	padding: 0;
}

.amp-wp-article-header .amp-wp-meta:last-of-type {
	text-align: right;
}

.amp-wp-article-header .amp-wp-meta:first-of-type {
	text-align: left;
}

.amp-wp-byline amp-img,
.amp-wp-byline .amp-wp-author {
	display: inline-block;
	vertical-align: middle;
}

.amp-wp-byline amp-img {
	border: 1px solid #0a89c0;
	border-radius: 50%;
	position: relative;
	margin-right: 6px;
}

.amp-wp-posted-on {
	text-align: right;
}

/* Featured image */

.amp-wp-article-featured-image {
	margin: 0 0 1em;
}
.amp-wp-article-featured-image amp-img {
	margin: 0 auto;
}
.amp-wp-article-featured-image.wp-caption .wp-caption-text {
	margin: 0 18px;
}

/* Article Content */

.amp-wp-article-content {
	margin: 0 16px;
}

.amp-wp-article-content ul,
.amp-wp-article-content ol {
	margin-left: 1em;
}

.amp-wp-article-content .wp-caption {
	max-width: 100%;
}

.amp-wp-article-content amp-img {
	margin: 0 auto;
}

.amp-wp-article-content amp-img.alignright {
	margin: 0 0 1em 16px;
}

.amp-wp-article-content amp-img.alignleft {
	margin: 0 16px 1em 0;
}

/* Captions */

.wp-caption {
	padding: 0;
}

.wp-caption.alignleft {
	margin-right: 16px;
}

.wp-caption.alignright {
	margin-left: 16px;
}

.wp-caption .wp-caption-text {
	border-bottom: 1px solid #c2c2c2;
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0;
	padding: .66em 10px .75em;
}

/* AMP Media */

.alignwide,
.alignfull {
	clear: both;
}

amp-carousel {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}
amp-iframe,
amp-youtube,
amp-instagram,
amp-vine {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}

.amp-wp-article-content amp-carousel amp-img {
	border: none;
}

amp-carousel > amp-img > img {
	object-fit: contain;
}

.amp-wp-iframe-placeholder {
	background: #c2c2c2 url( https://daynews.cc/wp-content/plugins/amp/assets/images/placeholder-icon.png ) no-repeat center 40%;
	background-size: 48px 48px;
	min-height: 48px;
}

/* Article Footer Meta */

.amp-wp-article-footer .amp-wp-meta {
	display: block;
}

.amp-wp-tax-category,
.amp-wp-tax-tag {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 1.5em 16px;
}

.amp-wp-comments-link {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	text-align: center;
	margin: 2.25em 0 1.5em;
}

.amp-wp-comments-link a {
	border-style: solid;
	border-color: #c2c2c2;
	border-width: 1px 1px 2px;
	border-radius: 4px;
	background-color: transparent;
	color: #0a89c0;
	cursor: pointer;
	display: block;
	font-size: 14px;
	font-weight: 600;
	line-height: 18px;
	margin: 0 auto;
	max-width: 200px;
	padding: 11px 16px;
	text-decoration: none;
	width: 50%;
	-webkit-transition: background-color 0.2s ease;
			transition: background-color 0.2s ease;
}

/* AMP Footer */

.amp-wp-footer {
	border-top: 1px solid #c2c2c2;
	margin: calc(1.5em - 1px) 0 0;
}

.amp-wp-footer div {
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: 1.25em 16px 1.25em;
	position: relative;
}

.amp-wp-footer h2 {
	font-size: 1em;
	line-height: 1.375em;
	margin: 0 0 .5em;
}

.amp-wp-footer p {
	color: #696969;
	font-size: .8em;
	line-height: 1.5em;
	margin: 0 85px 0 0;
}

.amp-wp-footer a {
	text-decoration: none;
}

.back-to-top {
	bottom: 1.275em;
	font-size: .8em;
	font-weight: 600;
	line-height: 2em;
	position: absolute;
	right: 16px;
}
		td, th {
	text-align: left;
}

a, a:active, a:visited {
	text-decoration: underline;
}

	</style>
	
</head>

<body class="">


<header id="top" class="amp-wp-header">
	<div>
		<a href="https://daynews.cc/">
									<span class="amp-site-title">
				天天要聞			</span>
		</a>

										<a class="amp-wp-canonical-link" href="https://daynews.cc/technology/9546/">
				原網頁			</a>
			</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">遠超雙11！eBay百萬TPS支付賬務系統的設計與實現</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://daynews.cc/wp-content/themes/Kratos/images/default_avatar.jpeg" alt="天天要聞" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">天天要聞</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2019-12-11T04:45:15+00:00">
		2019-12-11	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		
		<div>
<p><strong>一、序</strong></p>
<p>ebay於2018年全面展開了下一代支付系統的設計和實現。支付寶的雙十一和微信財付通的春節紅包已經向世界展示了支付行業當前的工程成果。那麼作為下一代支付系統，如何才能做得更好？支付寶的支付系統能支撐雙十一期間高達幾十萬的並發量，我們的支付系統有沒有可能支持得更高、更穩定？</p>
<p>俗話說擒賊先擒王，<strong>支付系統最重要的組件之一是賬務系統，有著極其嚴格的業務正確性和穩定性要求，我們便以此為突破點，開展了攻堅項目。</strong></p>
<p>我們支付團隊在2018年底接到項目後對支付行業做了充分的調研，首先確定了下一代賬務系統的設計目標：</p>
<p><strong>1）業務目標：</strong></p>
<ul>
<li>
<p>支持所有支付業務功能</p>
</li>
<li>
<p>擴展介面支持所有互金功能</p>
</li>
</ul>
<p><strong>2）容災目標：</strong></p>
<ul>
<li>
<p>三地五中心部署，數據中心級別容災</p>
</li>
<li>
<p>數據毫秒級實時異地同步備份，業務秒級異地主備切換</p>
</li>
</ul>
<p><strong>3）性能目標：</strong></p>
<ul>
<li>
<p>自動線性擴容</p>
</li>
<li>
<p>有能力承接全球所有支付公司峰值流量之和</p>
</li>
</ul>
<p><strong>4）數據目標：</strong></p>
<ul>
<li>
<p>實時數據中台</p>
</li>
<li>
<p>具備一定的區塊鏈所具有的數據防篡改能力</p>
</li>
</ul>
<p>接下來我們開展了為期半年的系統設計和原型實現。2019年，第一季度原型系統通過驗收，下一代核心賬務系統正式立項。經過半年緊鑼密鼓的開發，系統於今年第三季度正式灰度上線，並通過了性能和容災驗收。</p>
<p>本文主要介紹核心賬務系統的性能和容災能力，包含以下內容：</p>
<ul>
<li>
<p>核心賬務系統簡介</p>
</li>
<li>
<p>百萬TPS壓測實驗</p>
</li>
<li>
<p>系統架構分析</p>
</li>
<li>
<p>開源計劃</p>
</li>
</ul>
<p><strong>二、核心賬務系統簡介</strong></p>
<p>1、業務簡介</p>
<p>支付系統為賬戶間的資金流動提供系統性的解決方案。支付系統在處理轉賬業務的時候需要根據當前賬戶資金及流水情況對資金流動的金額、方向、業務合理性等做必要的業務校驗。所有這些核心轉賬業務和所有賬戶的資金及流水的維護均由核心賬務系統負責。<strong>支付系統幾乎所有的支付能力均建立在核心賬務系統之上，因此核心賬務系統是最重要的系統之一。</strong></p>
<p>2、系統簡介</p>
<p>賬戶資金是賬戶當前的狀態，每一筆資金流動都會對這些狀態進行查詢和修改。當用戶數和業務數超過一定規模後，單台機器就無法滿足系統的性價比要求，因此互聯網行業普遍採用了集群化的多機解決方案。<strong>但多機方案會遇到很多單機方案所沒有的挑戰：</strong></p>
<ul>
<li>
<p>如何將狀態劃分至多台機器</p>
</li>
<li>
<p>多台機器之間的連接出現問題時如何正確維護狀態</p>
</li>
<li>
<p>單個數據中心出現故障時如何保障業務的正確性和穩定性</p>
</li>
<li>
<p>跨城數據備份如何處理網路延時問題</p>
</li>
<li>
<p>系統如何快速地擴容和縮容</p>
</li>
<li>
<p>如何保證分布在多節點上的數據不會被惡意篡改</p>
</li>
</ul>
<p>核心賬務系統還面臨著很多其它的挑戰，這些挑戰會隨著系統流量的增加而變得更加嚴峻。當系統出現量變時，我們需要尋求質變。<strong>接下來讓我們看一看下一代的核心賬務系統如何應對量變和質變的挑戰。</strong></p>
<p><strong>三、百萬TPS壓測實驗</strong></p>
<p>1、實驗目標</p>
<p><strong>下一代核心賬務系統的首要設計目標是更好地支持電商業務。</strong>電商業務通常會面臨秒殺等短時超大規模用戶請求，此時系統需要具備瞬時線性擴容能力來確保用戶體驗。為此我們設計了<strong>百萬TPS壓力</strong>測試來驗收下一代核心賬務系統的相關能力。</p>
<p>2、實驗意義</p>
<p>支付寶的雙十一和微信的春節紅包等項目在十萬TPS的問題上已經有了成熟的解決方案。但業界對於百萬甚至更高TPS的問題尚無代表性的系統案例。百萬TPS意味著支付寶、微信財付通、國際卡組織、國際第三方支付等全球所有支付系統的線上峰值流量之和。由於支付業務與人類活動有關，存在物理上限，<strong>解決了百萬TPS的問題意味著一勞永逸地解決了賬務系統的基礎架構問題。</strong></p>
<p>另外，系統性能數量級的提升往往意味著架構的迭代更新，我們藉此機會就老的問題提出新的解法，希望這些新的想法能應用於更多其它系統，解決更多其它行業的問題。</p>
<p>3、實驗流程</p>
<p>實驗分為兩個部分：</p>
<ul>
<li>
<p>第一部分驗證單組節點的性能，業務場景為單商戶秒殺業務，系統驗證點為單組節點能支持的最高TPS；</p>
</li>
<li>
<p>第二部分驗證多節點集群的性能，業務場景為主站大促，系統驗證點為當TPS請求逐步上升時系統的自動擴容能力。</p>
</li>
</ul>
<p>4、系統準備</p>
<p>核心賬務系統在正式生產環境中的部署方式為<strong>三地五中心</strong>，本次壓測採用了簡化版的兩地三中心部署。每組為3個節點，跨城部署在2個數據中心。壓測共準備667組，合計2,001個業務節點。周邊輔助節點為2,350個。一共準備4,351個節點。這些節點總帶寬為128Gbps，總cpu core數量為14,767個，總內存為45T，總硬碟存儲空間為84T。所有硬體消耗3個機櫃，共300台物理機，總成本為450萬美元/3年。</p>
<p>5、實驗結果</p>
<p><strong>1）單組節點測試</strong></p>
<p>水電煤繳費、用戶還款、電商秒殺等業務均有大量用戶需要在指定時間點對單一賬戶做資金轉入操作。由於單個賬戶已無法再做分庫分表處理，單組節點的性能上限就決定了單個賬戶的交易量上限。因此，我們需要實施單組節點壓測，以了解單個賬戶的限制情況。</p>
<p><strong>①兩地三中心結果</strong></p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHewbSAUXXdXM" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="416" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHewbSAUXXdXM" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="416" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖3.1</p>
<p>在這個實驗中，<strong>三個數據節點部署在兩個異地數據中心，通過基於Raft共識演算法的強一致性協議進行實時數據同步。</strong>這是最常見的一種部署方案，兼顧了容災和業務處理響應時間。從圖3.1的測試結果看，1KB的請求，每秒最高能處理的交易量是7,800筆。</p>
<p>值得一提的是，當達到峰值後，由於請求接收階段的處理能力已到上限，P99（第99個百分位數）下單個轉賬請求的延時明顯增大。而批處理日誌寫入階段單次打包的日誌數量明顯上升，部分抵消了海量請求帶來的影響，P90下延時的增大幅度則相對較小。</p>
<p><strong>在整個測試過程中發生了一次Raft選主，導致了TPS的降低。</strong>這是因為新主上台前需要將自身的業務狀態追到最新，才能處理新的轉賬請求。和傳統基於Raft協議的應用相比（例如KVStore），這是支付應用較為獨特的地方。</p>
<p><strong>②同城三中心結果</strong></p>
<p> <amp-img src="http://p9.pstatp.com/large/pgc-image/RkHewbtHwPSptX" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="416" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p9.pstatp.com/large/pgc-image/RkHewbtHwPSptX" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="416" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖3.2</p>
<p>本次實驗為同機房三節點部署。從圖3.2可以看到，系統最高每秒可處理9,500筆交易。由於數據複製過程中只要有一個從節點(Raft follower)成功寫入日誌即可認為交易完成，而同數據中心內主從之間數據複製的時延僅為跨數據中心的1/12到1/8，所以每秒交易數相應增加。該效果與異地三中心部署時主從在同一數據中心的效果一致。</p>
<p>另一點值得指出的是，由於同數據中心內網路和跨數據中心相比更穩定，<strong>在整個實驗過程中沒有出現選主，TPS更加平穩。</strong></p>
<p><strong>③單中心結果</strong></p>
<p> <amp-img src="http://p3.pstatp.com/large/pgc-image/RkHewc75Q2zIJf" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="416" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p3.pstatp.com/large/pgc-image/RkHewc75Q2zIJf" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="416" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖3.3</p>
<p>本次實驗採用單節點部署，來測試數據複製對交易吞吐量的影響。和前兩次相比，該部署由於只要主節點（也是唯一的一個Raft節點）本地寫入成功即可認為交易完成，省去了數據複製的時間。從圖3.3可以看到，該部署下每秒交易能穩定在9,700筆，最高能處理將近1萬1千筆。可見，<strong>單</strong><strong>節點部署和同機房三節點部署的系統吞吐能力幾乎一致</strong>，這在一定程度上歸功於我們在提升網路吞吐量方面作的優化。</p>
<p><strong>2）多組節點測試</strong></p>
<p>在實際應用中，單組節點往往無法滿足大型電商平台對總交易量的實時性要求，因此需要部署多組節點，只讓每組節點承擔一部分賬戶的交易請求。<strong>我們測試了系統在兩個典型的業務場景下的表現。</strong></p>
<p><strong>①流量階梯上升，節點數量動態調整</strong></p>
<p> <amp-img src="http://p3.pstatp.com/large/pgc-image/RkHewcgFLquOBf" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="328" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p3.pstatp.com/large/pgc-image/RkHewcgFLquOBf" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="328" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖3.4</p>
<p>該實驗模擬的業務場景是主站日常流量漲跌，交易量會隨著某些外部事件而發生動態變化，例如全站大促時，網站流量會隨著人們作息而發生緩慢震蕩。</p>
<p>從圖3.4可以看出，實驗開始只有222組節點，當系統監測到單組節點的平均吞吐量開始上升並超過閾值時（意味著交易量上升，即將達到並超過單組節點的處理能力），系統會自動部署新的節點來分擔總體交易量。伴隨著節點數量的上升，平均吞吐量開始緩慢下降到閾值以下，同時保證總體交易量能被及時處理。該彈性擴容過程示意如下：</p>
<p> <amp-img src="http://p3.pstatp.com/large/pgc-image/RkHewdC37WfMGk" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="313" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p3.pstatp.com/large/pgc-image/RkHewdC37WfMGk" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="313" class=""></noscript></amp-img><br>
 <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHewy26XuQV2p" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="313" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHewy26XuQV2p" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="313" class=""></noscript></amp-img><br>
 <amp-img src="http://p9.pstatp.com/large/pgc-image/RkHewyVcGcyPT" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="313" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p9.pstatp.com/large/pgc-image/RkHewyVcGcyPT" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="313" class=""></noscript></amp-img></p>
<p>系統能動態調整節點數以自適應流量的變化，保證業務不受影響的同時也可以提高硬體的利用率。例如當交易量較低時，可以通過合併節點來減少資源。</p>
<p><strong>②瞬時超高流量，節點數量不變</strong></p>
<p>該實驗模擬的是主站大促，例如每年<strong>雙11的零點</strong>，流量洪峰會在極短的時間內湧向支付系統。我們分別測試了系統在瞬間收到50萬（圖3.5）和100萬（圖3.6）交易量的極端情況下的表現。</p>
<p> <amp-img src="http://p9.pstatp.com/large/pgc-image/RkHewysFjhWqeh" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="414" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p9.pstatp.com/large/pgc-image/RkHewysFjhWqeh" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="414" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖3.5</p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHewzLEbZLhE7" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="414" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHewzLEbZLhE7" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="414" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖3.6</p>
<p>從圖中可以看出，在這兩種情況下，<strong>系統均能從容穩定應對，雖然其中部分節點出現了換主（圖3.5），但對總體流量的影響微乎其微。</strong>測試過程中甚至還發現延時有短暫下降，這主要是由於批處理階段打包效率提升。</p>
<p>在達到峰值流量時我們還隨機查看了部分節點的資源使用情況，發現CPU並沒有被打滿，部分線程並未滿負荷運作。這說明流水線上各階段的處理能力強弱不一，後續調優後系統應該會有更好的表現。</p>
<p><strong>四、系統架構分析</strong></p>
<p>1、整體架構設計</p>
<p><strong>1）核心設計原則</strong></p>
<p>在解決超大流量時，電商系統及支付系統目前最流行的解決方案是通過<strong>分庫分表</strong>來做流量切分，通過分散式事務解決分庫分錶帶來的分散式一致性的問題。這是一個經過了實踐檢驗的解決方案。</p>
<p>但是近十年來經過開源社區和各大互聯網廠商的不斷努力，數據系統的設計有了長足的發展，湧現出了更多更好的解決方案。由於我們是從零開始設計一個新的系統，沒有歷史負擔，所以決定應用更為領先的系統設計來解決核心賬務系統所面臨的業務和系統複雜度問題。</p>
<p><strong>①業務複雜度處理</strong></p>
<p>金融系統是一個典型的業務複雜系統。我們計算過，對於信用卡業務來說，一共有573,099,840種不同的業務場景。傳統解決方案是所有系統直接基於資料庫表來進行開發。傳統方案的問題在於資料庫存儲的是數據的二進位格式，沒有業務邏輯，系統在使用資料庫的時候需要基於二進位形式來重構業務邏輯，正確性難以保障。</p>
<p>所幸隨著本世紀初<strong>領域驅動設計（Domain Driven Design）模式</strong>的出現，金融系統複雜度得到了系統性的解決。我們首先使用了領域模型來對金融業務建模，使得數據的業務表現層和存儲層分離。其次使用Event Sourcing來保證業務處理的正確性和對歷史狀態的百分百可追溯可還原。再者使用CQRS來實現系統讀寫分離。最後用流處理的方式自上而下、從外及內地統一所有設計。</p>
<p><strong>②多機事務問題</strong></p>
<p>系統在做水平擴容時需要處理數據正確性問題。傳統的方式一般採用分散式事務。我們<strong>基於賬務系統的特殊業務邏輯提出了基於消息最終一致性和業務補償的解決方案。</strong></p>
<p>多機方案除了正確性外還有一些其它需要注意的問題。首先是多了至少一次的網路開銷，增加了請求延時。其次，系統內部流量翻番，單機提供的業務TPS減半。最後由於基於消息最終一致性的實現無法同步返回結果給調用者，系統需要增加非同步轉同步的組件。</p>
<p><strong>③單機事務問題</strong></p>
<p>多機事務需要每台機器都具備本地事務的能力。傳統資料庫為了提高事務的執行性能普遍採取了多線程的並發執行機制。但是本世紀初的一些研究發現，對於有些業務場景，特別是金融行業，多線程並非最優解決方案。<strong>因此在核心賬務系統的設計過程中，我們確保核心賬務業務邏輯只在單線程執行，以便充分利用單線程執行所帶來的事務保證和性能優勢。</strong></p>
<p>單線程帶來的另一個好處是<strong>線性一致性（Linearizability）</strong>。事務只能保證多任務按照某種順序來<strong>串列化執行（Serializability）</strong>，在有多種可選順序的情況下，事務調度演算法並不保證每次均能選擇同一種確定順序。和事務的一致性不同，線性一致性能確保每次調度的順序完全一致。賬務系統要求所有記賬均按照一個確定的順序記錄，在發生系統回滾及重放後需要恢復至相同順序，因此線性一致性是一個對於賬務系統正確性來說非常重要的保證。</p>
<p><strong>④系統性能</strong></p>
<p>電商及支付系統通常採用基於SOA的節點間服務調用和基於Java Bean的節點內組件調用。但是在出現秒殺等場景時需要做一些特殊的削峰填谷工作。削峰填谷通常使用消息隊列來做緩衝，<strong>因此消息隊列也成為了一個必不可少的組件。</strong></p>
<p>與經典設計中所採用的<strong>部分非同步</strong>實現不一樣，我們在設計時<strong>全面使用了基於消息的非同步解決方案</strong>，包括系統間和系統內的功能調用。非同步方案帶來的挑戰是沒有同步介面，提高了調用方複雜度，因此需要利用前文提到的非同步轉同步組件來降低調用方複雜度。</p>
<p><strong>⑤系統容災</strong></p>
<p>金融系統對容災有極高的要求。首先是數據需要支持同城和異地備份，確保數據有區域級災備能力。再者需要支持業務的快速自動主備切換，時間就是金錢。</p>
<p>傳統方案是基於資料庫自帶的異地備份，分為非同步和同步兩種備份方式：</p>
<ul>
<li>
<p>如果是<strong>非同步備份</strong>，由於數據並沒有被及時同步至備份節點，主節點出問題時會有數據丟失。</p>
</li>
<li>
<p>如果是<strong>同步備份</strong>，則主備機必須同時在線，任何一台出現問題都會導致業務中斷。備機越多，當中任何一台出問題的概率越大，業務中斷的概率也越大，因此同步備份的問題在於數據容災能力越強，系統越不穩定。</p>
</li>
</ul>
<p>我們採用了新的方式來達到同時提高數據容災和系統穩定性的效果。新的方法和同步備份一樣需要備機同步返回備份結果，但只要求大部分返回即可，不需要全部返回。這個方法稱為<strong>共識演算法族（consensus）</strong>。我們選取了其中的Raft演算法，從零開始實現自己的高效定製化的強一致性演算法。</p>
<p>賬務系統的核心數據會通過強一致性演算法實時同步至3個數據中心的5個存儲節點。系統只要有多於一半的節點能正常工作便能整體正常運行，因此該部署計劃允許5個節點中任意2個節點同時出現問題。由於單個數據中心出現問題時最多只能影響2個節點，因此該部署計劃能支持數據中心級別的災備要求。該部署俗稱三地五中心部署。三地五中心的簡化版為<strong>兩地三中心</strong>，也是我們在此次壓力測試中所採用的模型，如圖4.1所示：</p>
<p> <amp-img src="http://p3.pstatp.com/large/pgc-image/RkHewzbIx3szK7" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="286" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p3.pstatp.com/large/pgc-image/RkHewzbIx3szK7" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="286" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.1</p>
<p>我們創新性地採用了<strong>雙層（核心業務層和基礎架構層）</strong>一體的設計來實現業務的快速自動主備切換。當數據出現災備切換時，定製化的Raft演算法會同時切換數據和業務邏輯至災備節點。</p>
<p>為了能更好地證明系統的容災能力，我們在生產環境部署了<strong>定時自動容災演練系統</strong>。該系統會不定時的對系統進行隨機的可用性攻擊，從而驗證生產環境中面對網路、硬碟、內存等出現異常情況時系統的容忍能力。</p>
<p><strong>2）分層設計</strong></p>
<p>核心賬務系統從上至下分為4層：</p>
<ul>
<li>
<p>賬務業務層</p>
</li>
<li>
<p>基礎賬務層</p>
</li>
<li>
<p>基礎架構層</p>
</li>
<li>
<p>存儲層</p>
</li>
</ul>
<p>另外還有一個縱向貫穿始終的<strong>監控層</strong>，負責收集監控數據和跨層監控。架構示意圖見圖4.2：</p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHexKFEJk1nWP" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="502" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHexKFEJk1nWP" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="502" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.2</p>
<p><strong>最上層的賬務業務層</strong>提供外部訪問介面，負責處理最上層的業務邏輯，有一定的對外I/O請求，內部無狀態。業務會被分解為多個條件轉賬請求發給下層的<strong>基礎賬務層</strong>。基礎賬務層負責記賬，對外無I/O請求，內部有狀態。該狀態由基礎架構層提供的狀態機來維護。<strong>基礎架構層</strong>負責提供一個基於Raft演算法的高效穩定的狀態機實現，其性能由單線程保證，穩定性由強一致性演算法來保證。基礎賬務層處理完的結果為會計賬本，會輸出給<strong>存儲層</strong>。完整的分層架構圖如下圖4.3所示：</p>
<p> <amp-img src="http://p9.pstatp.com/large/pgc-image/RkHexKoIf7QKGk" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="600" height="330" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p9.pstatp.com/large/pgc-image/RkHexKoIf7QKGk" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="600" height="330" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.3</p>
<p>2、Event Sourcing</p>
<p><strong>1）原理</strong></p>
<p>基礎賬務層和基礎架構層是根據Event Sourcing的原則來設計的，這也是核心賬務系統最重要的架構設計。</p>
<p>Event Sourcing有4個主要組成部分：</p>
<ul>
<li>
<p>Command：外部請求</p>
</li>
<li>
<p>Event：事件</p>
</li>
<li>
<p>State：狀態</p>
</li>
<li>
<p>State Machine：狀態機</p>
</li>
</ul>
<p>所有外部請求會先被發送給狀態機。狀態機會結合當前狀態生成事件。事件被存入<strong>事件倉庫（Event Store）</strong>後會被狀態機執行，進而改變狀態機內的狀態。如圖4.4所示：</p>
<p> <amp-img src="http://p9.pstatp.com/large/pgc-image/RkHexL45jWW1h5" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="494" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p9.pstatp.com/large/pgc-image/RkHexL45jWW1h5" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="494" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.4</p>
<p>圖4.5展示了多個事件處理時的時序圖：</p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHexLUBG7PRBe" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="286" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHexLUBG7PRBe" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="286" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.5</p>
<p>舉一個賬務系統的例子。賬務系統接收到的一個命令是「從甲轉乙100美金，但甲不能出現餘額不足的情況」。當前狀態為「甲有150美金，乙有50美金」。狀態機在收到命令後檢查當前狀態情況，確認轉賬後不會出現甲餘額不足的情況，因此生成事件「甲轉出100美金，乙轉入100美金」。</p>
<p><strong>注意，狀態機對於同一個命令可能生成不同的事件，完全取決於當前狀態。</strong>還是剛才的例子，如果此時甲餘額只有50美金，轉賬100美金的命令將無法被成功執行，此時狀態機會生成一個轉賬失敗事件。</p>
<p>一旦事件被生成並存入事件倉庫，該事件就一定會被狀態機執行，進而改變狀態機內的狀態。對於本例子來說，甲開始狀態為150美金，在轉出100美金後的結束狀態為剩餘50美金。</p>
<p>命令和事件會按順序記錄並處理。這個過程是一個經典的<strong>資料庫回滾日誌（WAL，Write Ahead Log）</strong>案例，也是賬務系統的本地數據存儲格式。由於單機機器故障可能會導致日誌丟失，我們採用<strong>Raft強一致性演算法</strong>來增強數據容災能力。日誌首先會被存儲為臨時狀態，只有當日誌被安全備份到多於一半的機器後才會被更改為已提交狀態，允許外部訪問和處理。</p>
<p>數據存儲格式為資料庫回滾日誌，當系統出錯後會進行標準的資料庫回滾和恢復過程。如圖4.6所示：</p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHexMB7cYWDyw" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="263" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHexMB7cYWDyw" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="263" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.6</p>
<p><strong>2）CQRS</strong></p>
<p><strong>CQRS（Command Query Responsibility Segregation），即俗稱的讀寫分離</strong>，也是Event Sourcing提出來的一個概念。命令和事件會改變狀態機的狀態，是一個寫的過程。事件一旦生成便不可修改，同時事件之間有嚴格的先後順序關係，用戶可以通過順序監聽事件來重構狀態的備份，甚至增加自己的特殊邏輯來生成定製化的視圖，這便是一個讀的過程。</p>
<p>例如核心賬務系統的所有事件為記賬消息，我們通過監聽消息來生成餘額狀態，並將其保存至關係型資料庫和Kafka等數據流系統做實時聚合。</p>
<p><strong>3）流處理</strong></p>
<p>我們在CQRS的基礎上更進了一步。鑒於命令和事件都是通過消息系統來傳輸，加之CQRS設計模式中寫和讀兩個操作之間也是通過消息系統來傳輸，<strong>一個自然的整體解決方案即為：</strong><strong>用流處理的架構來設計整個賬務系統的消息傳送和處理。</strong></p>
<p>各個處理節點，比如處理事件的節點或者是生成視圖的節點，均可以看作流處理的計算節點。流處理的最上層節點通過強一致性演算法來保證數據和狀態的高可用及一致性。但這些通過了強一致性同步的數據在向下游流動的過程中依然可能會出現丟失。但因為最上游數據有線性一致性保證，下游能通過檢測線性一致性來判斷是否出現了數據丟失，進而通過查詢上游來進行數據補償。這意味著下游數據並不一定需要強一致性演算法，我們可以選用一致性稍弱的消息系統，比如Kafka，來作為下游的消息管道。如圖4.7所示：</p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHexcoCBASITr" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="299" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHexcoCBASITr" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="299" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.7</p>
<p>3、系統實現</p>
<p><strong>1）實現</strong></p>
<p>前幾章提到了系統的分層。業務層主要處理賬務業務邏輯，為<strong>無狀態節點</strong>，容易橫向擴展，由Java實現。核心業務層和基礎架構層負責處理和維護業務狀態，為<strong>有狀態節點</strong>，有穩定性、強一致性及性能表現等需求，由C++實現。其餘輔助性組件由go實現。</p>
<p>我們選取了C++17標準，利用了新標準下的一些新功能，並在實現過程中大量使用了<strong>函數式編程的思想</strong>。使用函數式編程思想的主要目的是確保核心邏輯的可組合性及行為可重現性，同時也確保核心數據結構在多線程情況下的正確性。</p>
<p><strong>2）優化</strong></p>
<p>優化主要集中在C++部分，主要優化兩點：</p>
<ul>
<li>
<p>吞吐量；</p>
</li>
<li>
<p>延時。</p>
</li>
</ul>
<p>我們創新性地採用了雙層（核心業務層和基礎架構層）一體的設計，並結合流水線和批處理，在提高系統吞吐量，降低延時的同時避免了常見的因為雙層分離由網路造成的各種狀態不一致的問題。為了保證該設計實現的正確性，我們使用<strong>Jepsen測試框架</strong>，並針對性地設計了測試用例，來確保在各種異常情況發生時，系統均能正常工作。</p>
<p><strong>提高系統吞吐量的常用方法為流水線。</strong>把對外部請求的處理過程劃分成若干個階段，每個階段獨立運行，階段之間使用隊列連結，上一個階段的輸出是下一個階段的輸入，形成一條流水線。<strong>這樣設計的好處在於可以針對每個階段的特點做獨立優化。</strong>例如在數據接收階段，使用多線程來提高單位時間內請求接收的數量；在數據同步階段，採用批處理方式來降低網路開銷；在核心處理階段，每個請求必須順序執行以保證狀態正確，因此我們採用了一些僅在<strong>對沖基金高頻交易系統</strong>中才會使用的特殊優化方法來提高處理速度。</p>
<p><strong>系統延時主要發生在網路請求上。</strong>觀測到的一次跨數據中心請求延時在幾毫秒左右，發生網路抖動時的延時在幾十毫秒左右。正常的一次網路請求對用戶體驗沒有大的影響。</p>
<p>但是Event Sourcing會帶來兩個問題。</p>
<p>第一個問題是Event Sourcing處理每個業務事件時需要實時同步災備兩次：第一次備份Command，Command備份完成後再備份Event。這兩次備份有先後依賴關係，無法同步處理。</p>
<p>另一個問題是多個業務事件彼此之間需要按順序先後處理，如果亂序處理會帶來業務的不正確性。圖4.8列舉了2個事件共4步順序網路同步過程：</p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHexdJFz1qfcM" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="338" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHexdJFz1qfcM" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="338" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.8</p>
<p>通過一些特殊的數據結構優化和運行順序調整，我們成功地優化掉了絕大多數網路請求。最後結果為：對於同一批需要處理的事件，系統只需要執行一次網路同步。我們也論證了在多線程情況下強一致演算法在多節點集群換主時，各個狀態機均能運行或回滾至正確的狀態。優化後的2個事件共1步順序網路同步過程如圖4.9所示：</p>
<p> <amp-img src="http://p1.pstatp.com/large/pgc-image/RkHexe9Hj4xywj" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="293" class="amp-wp-enforced-sizes" layout="intrinsic"><noscript><img src="http://p1.pstatp.com/large/pgc-image/RkHexe9Hj4xywj" alt="《遠超雙11！eBay百萬TPS支付賬務系統的設計與實現》" width="640" height="293" class=""></noscript></amp-img></p>
<p class="pgc-img-caption">圖4.9</p>
<p><strong>3）部署</strong></p>
<p>系統部署在基於docker和k8s的雲平台，支持一鍵雲部署。同時由於系統對所有IO進行了抽象和封裝，能通過分散式配置服務動態切換存儲媒介，系統在部署時能選擇遠程部署，或者完全基於本地單機文件系統的部署，即俗稱的單機版本。單機版本包含了完整的業務、數據、存儲、監控等系統，極大地方便了系統的開發與上線。</p>
<p><strong>五、開源計劃</strong></p>
<p>我們會分三步來逐步開放系統功能和代碼：</p>
<ul>
<li>
<p>對高校等科研單位開放源代碼；</p>
</li>
<li>
<p>對商業合作夥伴開放功能和源代碼；</p>
</li>
<li>
<p>對所有人開源。</p>
</li>
</ul>
<p>目前我們已經和英美幾所大學開展了深入的科研合作，以核心賬務系統為研究對象進行分散式系統前沿的研究。我們和商業合作夥伴的合作也正在同步進行當中。<strong>我們會於明年年底開源所有的代碼和文檔</strong>，敬請期待。</p>
<p class="pgc-end-source">作者丨任傑</p>
<p class="pgc-end-source">來源丨eBay技術薈（ID：eBayTechRecruiting）</p>
<p class="pgc-end-source">dbaplus社群歡迎廣大技術人員投稿，投稿郵箱：editor@dbaplus.cn</p>
</div>
	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		分類: <a href="https://daynews.cc/technology/" rel="category tag">科技</a>	</div>

		<div class="amp-wp-meta amp-wp-comments-link">
		<a href="https://daynews.cc/technology/9546/#comments">
			寫評論		</a>
	</div>
	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>天天要聞</h2>
		<a href="#top" class="back-to-top">返回頂部</a>
	</div>
</footer>


<amp-analytics id="354f0d2beeef" type="baiduanalytics"><script type="application/json">{"vars":{"token":"882f12dcdadf8f87fabf76b550649115"},"triggers":{"trackPageview":{"on":"visible","request":"pageview"}}}</script></amp-analytics>
</body>
</html>
<!-- This is the static html file -->